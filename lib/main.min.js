!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("gyrejs-main",[],t):"object"==typeof exports?exports["gyrejs-main"]=t():e["gyrejs-main"]=t()}(window,function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([,function(e,t,r){"use strict";r.r(t);class i{constructor(){this.readyQueue=[],this.readyQueueIDlist=new Set,this.timeBudget=10,this.projectionData=new Map,this.listeners=new Map,this.listenerCount=1}register(e,t,r={priority:0,id:"unnamed"}){const i=this.listenerCount;return this.listeners.set(this.listenerCount,{cb:t,pIds:e,id:r.id,priority:r.priority}),this.addIListenerToQueue(i),this.listenerCount+=1,i}unregister(e,t=[]){if(this.listeners.has(e)){0===this.listeners.get(e).pIds.filter(e=>!(t.indexOf(e)>-1)).length&&this.listeners.delete(e);let r=this.readyQueue.length;for(;r;)t.indexOf(this.readyQueue[r-1].pId)>-1&&(this.readyQueueIDlist.delete(i.createIDForIQueueItem(this.readyQueue[r-1])),this.readyQueue.splice(r,1)),r-=1}}setTimeBudget(e){this.timeBudget=e}getTimeBudget(){return this.timeBudget}projectionUpdate(e,t){this.projectionData.set(e,t),this.listeners.forEach((t,r)=>{t.pIds.indexOf(e)>-1&&this.scheduleIListener(r,e)})}runOnce(){const e=i.getCurrentTime();let t=!1;for(;(i.getCurrentTime()<e+this.timeBudget||!t)&&this.readyQueue.length>0;){const e=this.readyQueue.pop(),r=this.getCallbackById(e.lsId);if(!r)continue;if(e.genFn){let r;try{r=e.genFn.next()}catch(t){console.error(`[GyreJS] Error during invocation of listener (id: ${e.lsId}) for projection ${e.pId}: `,t)}r.done||this.readyQueue.push(e);continue}let i;try{i=r(this.projectionData.get(e.pId),e.pId)}catch(t){console.error(`[GyreJS] Error during invocation of listener (id: ${e.lsId}) for projection ${e.pId}: `,t)}i&&i.next&&(i.next().done||(e.genFn=i,this.readyQueue.push(e))),t=!0}this.readyQueue.length&&this.readyQueue.forEach(e=>{e.priority+=e.priority<89?1:0})}static getCurrentTime(){return Date.now()}getCallbackById(e){const t=this.listeners.get(e);return t?t.cb:null}addIListenerToQueue(e){this.listeners.get(e).pIds.forEach(t=>{this.projectionData.has(t)&&this.scheduleIListener(e,t)})}scheduleIListener(e,t){const r=this.listeners.get(e);if(r){const s={pId:t,lsId:e,priority:r.priority};if(this.readyQueueIDlist.has(i.createIDForIQueueItem(s)))return;let n=this.readyQueue.length;if(0===n||r.priority>this.readyQueue[n-1].priority)this.addItemToQueue(s,n);else if(this.readyQueue[0].priority>r.priority)this.addItemToQueue(s,0);else do{if(n-=1,this.readyQueue[n].priority<=r.priority){this.addItemToQueue(s,n+1);break}}while(n)}}addItemToQueue(e,t){0===t?this.readyQueue.unshift(e):t===this.readyQueue.length?this.readyQueue.push(e):this.readyQueue.splice(t,0,e),this.readyQueueIDlist.add(i.createIDForIQueueItem(e))}static createIDForIQueueItem(e){return e.lsId+"-"+e.pId}}class s{constructor(e){this.scheduler=new i,this.startWorker(e.workerScriptPath)}trigger({id:e,data:t}){this.bWorker.postMessage({id:e,data:t,type:"event"})}issue({id:e,data:t}){this.bWorker.postMessage({id:e,data:t,type:"command"})}register(e,t,r={priority:0,id:"unnamed"}){const i=s.checkIfValidProjectionId(e);if("function"!=typeof t)throw"[GyreJS] Callback should be a function.";if(r.priority<0||r.priority>99)throw"[GyreJS] IListener priority should be a number in range of [0,99].";if("string"!=typeof r.id)throw"[GyreJS] IListener id should be a string.";this.scheduler.register(i,(e,r)=>{t(e,r,this.trigger.bind(this),this.issue.bind(this))})}unregister(e,t){const r=s.checkIfValidProjectionId(t);this.scheduler.unregister(e,r)}startWorker(e){this.bWorker=new Worker(e),this.bWorker.onmessage=this.projectionUpdate.bind(this)}projectionUpdate(e){this.scheduler.projectionUpdate(e.data.id,e.data.data)}static checkIfValidProjectionId(e){if("string"!=typeof e&&e.constructor!==Array)throw"ProjectionId should be a(n array of) string(s) with non-zero length.";if("string"==typeof e&&0===e.length)throw"ProjectionId should be a(n array of) string(s) with non-zero length.";return"string"!=typeof e&&e.forEach(e=>{if("string"!=typeof e||0===e.length)throw"ProjectionId should be a(n array of) string(s) with non-zero length."}),"string"==typeof e?[e]:e}}r.d(t,"Gyre",function(){return s})}])});
//# sourceMappingURL=main.min.js.map